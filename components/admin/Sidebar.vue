<template>
  <aside ref="sidebar" class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3" id="sidenav-main" :class="{open: sidebarOpen}">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <NuxtLink to="/admin/dashboard" class="d-flex navbar-brand m-0">
        <img
          src="~/assets/images/logo.png"
          class="navbar-brand-img"
          :alt="$t('global.logo.alt')"
        />
        <span v-if="showProjectName" class="ms-1 font-weight-bold">{{ $t('global.project') }}</span>
      </NuxtLink>
    </div>
    <hr class="horizontal dark mt-0" />
    <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <template v-if="loading && !navigationItems.length">
          <li class="nav-item" v-for="index in 5" :key="index">
            <div
              class="nav-link"
            >
              <div
                class="
                icon icon-shape icon-sm
                shadow
                border-radius-md
                bg-white
                text-center
                me-2
                d-flex
                align-items-center
                justify-content-center
              "
              >
              </div>
              <Skeletor
                class="nav-link-text ms-1"
                height="30"
                :width="Math.random() * 20 + 80 + '%'"
              />
            </div>
          </li>
        </template>
        <template v-else>
          <template v-for="topLayerNavItem in navigationItems">
            <li class="nav-item" :key="topLayerNavItem.name" v-if="rolesAndPermissions.hasAnyPermission(topLayerNavItem.permissions) || rolesAndPermissions.hasRole('SuperAdmin')">
              <NuxtLink
                @click="toggleMenu(topLayerNavItem.slug)"
                v-if="topLayerNavItem.route"
                class="nav-link"
                :to="routeParser.routeDottedToSlash(topLayerNavItem.route)"
                :class="{active: activeParent && activeParent ===topLayerNavItem.slug || !activeParent && topLayerNavItem.slug === 'dashboard' }"
              >
                <div
                  class="
                icon icon-shape icon-sm
                shadow
                border-radius-md
                bg-white
                text-center
                me-2
                d-flex
                align-items-center
                justify-content-center
              "
                >
                  <fa :icon="topLayerNavItem.icon"/>
                </div>
                <span class="nav-link-text ms-1">{{ $t(topLayerNavItem.name) }}</span>
              </NuxtLink>
              <a
                @click="toggleMenu(routeParser.routeDottedToSlash(topLayerNavItem.slug, false))"
                v-else
                class="nav-link menu-dropdown"
                :class="[{active: activeParent === routeParser.routeDottedToSlash(topLayerNavItem.slug, false)}, 'menu-' + topLayerNavItem.slug]"
              >
                <div
                  class="
                icon icon-shape icon-sm
                shadow
                border-radius-md
                bg-white
                text-center
                me-2
                d-flex
                align-items-center
                justify-content-center
              "
                >
                  <fa :icon="topLayerNavItem.icon" />
                </div>
                <span class="nav-link-text ms-1">{{ $t(topLayerNavItem.name) }}</span>
              </a>
              <ul
                v-if="topLayerNavItem.items"
                :class="[{open: activeParent === topLayerNavItem.slug}, 'menu-' + topLayerNavItem.slug + '-items']"
                class="navbar-nav sidebar-dropdown"
              >
                <template v-for="childNavItem in topLayerNavItem.items" :key="childNavItem.slug">
                  <li
                    v-if="rolesAndPermissions.hasAnyPermission(childNavItem.permissions) || rolesAndPermissions.hasRole('SuperAdmin')"
                    class="nav-item ps-5"
                    @click="setActiveChild(childNavItem.slug)"
                  >
                    <NuxtLink
                      :to="routeParser.routeDottedToSlash(childNavItem.route ? childNavItem.route : '')"
                      class="nav-link"
                      :class="[{active: activeChild === childNavItem.slug}, 'route-' + childNavItem.route?.replace(/\./g, '-')]"
                    >
                      {{ $t(childNavItem.name) }}
                    </NuxtLink>
                  </li>
                </template>
              </ul>
            </li>
          </template>
        </template>
      </ul>
    </div>
  </aside>
</template>
<script setup lang="ts">
import {storeToRefs} from "pinia";
import useRouteParser from "@zrm/motor-nx-core/composables/route/parse";
import {Skeletor} from "vue-skeletor";
import 'vue-skeletor/dist/vue-skeletor.css'
import type NavigationItem from "@zrm/motor-nx-core/types/navigation-item";
import useRolesAndPermissions from "@zrm/motor-nx-core/composables/auth/rolesAndPermissions";

const runtimeConfig = useRuntimeConfig();
const showProjectName = computed(() => runtimeConfig.public.showProjectName);
const navigationStore = useNavigationStore();
const { activeParent, activeChild , navigationItems, loading} = storeToRefs(navigationStore);
const { setActiveChild, toggleMenu, getNavigationItems } = navigationStore;
const routeParser = useRouteParser();
const route = useRoute();
const appStore = useAppStore();
const {sidebarOpen} = storeToRefs(appStore);
const sidebar = ref(null);

// onClickOutside(sidebar, (event) => {
//   if (sidebarOpen.value) {
//     appStore.toggleSidebar();
//   }
// })

// Route parser for different cases (01 März 2023  Martin Henrichs)
const { routeSlashToDotted, routeRemoveCRUD } = useRouteParser()
const currentRoute = ref(routeRemoveCRUD(routeSlashToDotted(route.fullPath)));

// Wrapper to set navigation parent and child (01 März 2023  Martin Henrichs)
const setActiveParentChild = (parent: string = '', child: string = '' ) => {
  navigationStore.setActiveParent(parent);
  navigationStore.setActiveChild(child);
}

// Set initial navigation active state by route (28 Feb. 2023  Martin Henrichs)
const initialNaviActionState = () => {
  for (const topLayerNavigationRecord in navigationItems.value) {
    const topLayerNavigationItem: NavigationItem = navigationItems.value[topLayerNavigationRecord];

    //Case: The top most navigation items do have a route => they can be selected & will be marked as selected
    if (topLayerNavigationItem.route === currentRoute.value) {
      setActiveParentChild(topLayerNavigationItem.slug)
      break;
    }

    //Case: The top most navigation items don't have a route => can't be selected => child needs to be selected
    if (topLayerNavigationItem.route === null) {
      for (const childRecord in topLayerNavigationItem.items) {
        const childNavigationItem = topLayerNavigationItem.items[childRecord];
        // Set parent and child if exist(28 Feb. 2023  Martin Henrichs)
        if (childNavigationItem.route === currentRoute.value) {
          setActiveParentChild(topLayerNavigationItem.slug, childNavigationItem.slug)
          break;
        }
      }
    }
  }
}

await getNavigationItems();

watch(() => route.fullPath, () => {
  currentRoute.value =  routeRemoveCRUD(routeSlashToDotted(route.fullPath));
  initialNaviActionState()
}, {immediate: true})

const rolesAndPermissions = useRolesAndPermissions();
</script>
<style lang="scss">

.menu-dropdown {
  cursor: pointer;
}

.sidenav {
	background-color: var(--c-light-100);
  transform: translateX(-100%);

  &.open {
    transform: translateX(0);
  }

  &:not(.open) {
    display: none;
  }
}

.sidebar-dropdown {
  max-height: 0;
  overflow-y: hidden;

  &.open {
    max-height: 1500px;
    overflow-y: hidden;
    transition: max-height 0.3s ease-in-out;
  }
}
</style>
